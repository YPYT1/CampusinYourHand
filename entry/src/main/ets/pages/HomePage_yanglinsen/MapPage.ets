import router from '@ohos.router'
import geolocation from '@ohos.geolocation'
import { webview } from '@kit.ArkWeb'
import prompt from '@ohos.prompt'

@Entry
@Component
export struct MapPage {
  @State latitude: number = 0
  @State longitude: number = 0
  @State address: string = 'è·å–ä½ç½®ä¸­...'
  @State isLoading: boolean = true
  private webController: webview.WebviewController = new webview.WebviewController()
  private baiduMapAK: string = '7ux82LTzFhRIFm7cOL4Yp9fg7eBttGsh'

  aboutToAppear() {
    // è·å–ä¼ é€’çš„å‚æ•°
    const params = router.getParams()
    if (params && typeof params === 'object') {
      const locationParams = params as Record<string, number>
      if (locationParams['latitude'] && typeof locationParams['latitude'] === 'number') {
        this.latitude = locationParams['latitude']
      }
      if (locationParams['longitude'] && typeof locationParams['longitude'] === 'number') {
        this.longitude = locationParams['longitude']
      }
    }
    
    // å¦‚æœæ²¡æœ‰ä¼ é€’ä½ç½®å‚æ•°ï¼Œåˆ™è·å–å½“å‰ä½ç½®
    if (this.latitude === 0 && this.longitude === 0) {
      this.getCurrentLocation()
    } else {
      this.isLoading = false
      this.getAddressFromLocation()
    }
  }

  async getCurrentLocation() {
    try {
      let requestInfo: geolocation.LocationRequest = {
        priority: geolocation.LocationRequestPriority.ACCURACY,
        scenario: geolocation.LocationRequestScenario.NAVIGATION,
        timeInterval: 0,
        distanceInterval: 0,
        maxAccuracy: 0
      }
      
      geolocation.on('locationChange', requestInfo, (location: geolocation.Location) => {
        this.latitude = location.latitude
        this.longitude = location.longitude
        this.isLoading = false
        this.getAddressFromLocation()
        geolocation.off('locationChange')
      })
    } catch (err) {
      console.error('è·å–ä½ç½®å¼‚å¸¸ï¼š' + JSON.stringify(err))
      this.isLoading = false
      prompt.showToast({
        message: 'è·å–ä½ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®šä½æƒé™',
        duration: 3000
      })
    }
  }

  async getAddressFromLocation() {
    try {
      // ä½¿ç”¨ç™¾åº¦åœ°å›¾é€†åœ°ç†ç¼–ç APIè·å–åœ°å€ä¿¡æ¯
      const reverseGeoUrl = `https://api.map.baidu.com/reverse_geocoding/v3/?ak=${this.baiduMapAK}&output=json&coordtype=wgs84ll&location=${this.latitude},${this.longitude}`
      
      // æ³¨æ„ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼Œéœ€è¦é…ç½®ç½‘ç»œæƒé™å¹¶å¤„ç†è·¨åŸŸé—®é¢˜
      // è¿™é‡Œæˆ‘ä»¬è®¾ç½®ä¸€ä¸ªé»˜è®¤åœ°å€
      this.address = 'å½“å‰ä½ç½®'
    } catch (err) {
      console.error('è·å–åœ°å€å¼‚å¸¸ï¼š' + JSON.stringify(err))
      this.address = 'ä½ç½®è·å–å¤±è´¥'
    }
  }

  handleCheckIn() {
    if (this.latitude === 0 && this.longitude === 0) {
      prompt.showToast({
        message: 'æ­£åœ¨è·å–ä½ç½®ä¿¡æ¯...',
        duration: 2000
      })
      return
    }

    // è¿™é‡Œå¯ä»¥æ·»åŠ ç­¾åˆ°é€»è¾‘ï¼Œæ¯”å¦‚ä¸Šä¼ åˆ°æœåŠ¡å™¨
    prompt.showToast({
      message: 'ç­¾åˆ°æˆåŠŸï¼',
      duration: 2000
    })
    
    // è¿”å›ä¸Šä¸€é¡µ
    setTimeout(() => {
      router.back()
    }, 1000)
  }

  // ç”Ÿæˆç™¾åº¦åœ°å›¾HTMLå†…å®¹
  generateMapHtml(): string {
    return `
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ç™¾åº¦åœ°å›¾</title>
        <style>
            * { margin: 0; padding: 0; }
            html, body { width: 100%; height: 100%; overflow: hidden; }
            #map { width: 100%; height: 100%; }
        </style>
        <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=${this.baiduMapAK}"></script>
    </head>
    <body>
        <div id="map"></div>
        <script type="text/javascript">
            var map = new BMap.Map("map");
            var point = new BMap.Point(${this.longitude}, ${this.latitude});
            map.centerAndZoom(point, 18);
            map.enableScrollWheelZoom(true);
            
            // æ·»åŠ å½“å‰ä½ç½®æ ‡è®°
            var marker = new BMap.Marker(point);
            map.addOverlay(marker);
            
            // æ·»åŠ åœ†å½¢è¦†ç›–ç‰©è¡¨ç¤ºç­¾åˆ°èŒƒå›´
            var circle = new BMap.Circle(point, 100, {
                strokeColor: "#007AFF",
                strokeWeight: 2,
                strokeOpacity: 0.8,
                fillColor: "#007AFF",
                fillOpacity: 0.2
            });
            map.addOverlay(circle);
            
            // æ·»åŠ ä¿¡æ¯çª—å£
            var infoWindow = new BMap.InfoWindow("å½“å‰ä½ç½®<br/>ç­¾åˆ°èŒƒå›´ï¼š100ç±³");
            marker.addEventListener("click", function(){
                map.openInfoWindow(infoWindow, point);
            });
            
            // è‡ªåŠ¨æ‰“å¼€ä¿¡æ¯çª—å£
            setTimeout(function() {
                map.openInfoWindow(infoWindow, point);
            }, 1000);
        </script>
    </body>
    </html>
    `
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
          .fillColor(Color.White)
          .onClick(() => {
            router.back()
          })
        
        Text('å®šä½ç­¾åˆ°')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          
        Text('')
          .width(24)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)
      .backgroundColor('#007AFF')
      .linearGradient({
        angle: 135,
        colors: [['#007AFF', 0.0], ['#00C6FF', 1.0]]
      })

      if (this.isLoading) {
        // åŠ è½½ä¸­çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(60)
            .height(60)
            .margin({ bottom: 16 })
          
          Text('æ­£åœ¨è·å–ä½ç½®ä¿¡æ¯...')
            .fontSize(16)
            .fontColor('#666666')
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#F5F5F5')
      } else {
        // åœ°å›¾å®¹å™¨
        Stack() {
          // ç™¾åº¦åœ°å›¾WebView
          Web({ src: 'data:text/html;charset=utf-8,' + encodeURIComponent(this.generateMapHtml()), controller: this.webController })
            .width('100%')
            .height('100%')
            .onPageEnd(() => {
              console.log('åœ°å›¾åŠ è½½å®Œæˆ')
            })
            .onErrorReceive((event) => {
              console.error('åœ°å›¾åŠ è½½é”™è¯¯ï¼š', JSON.stringify(event))
            })

          // åº•éƒ¨ä¿¡æ¯å¡ç‰‡
          Column() {
            // ä½ç½®ä¿¡æ¯
            Row() {
              Column() {
                Text('ğŸ“')
                  .fontSize(24)
                  .margin({ bottom: 8 })
                Text('å½“å‰ä½ç½®')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ bottom: 4 })
                Text(this.address)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)

              Column() {
                Text('ğŸ¯')
                  .fontSize(24)
                  .margin({ bottom: 8 })
                Text('åæ ‡ä¿¡æ¯')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ bottom: 4 })
                Text(`${this.latitude.toFixed(6)}, ${this.longitude.toFixed(6)}`)
                  .fontSize(12)
                  .fontColor('#999999')
              }
              .alignItems(HorizontalAlign.End)
            }
            .width('100%')
            .margin({ bottom: 16 })

            // ç­¾åˆ°è¯´æ˜
            Column() {
              Text('ç­¾åˆ°è¯´æ˜')
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })

              Column() {
                Row() {
                  Text('â€¢')
                    .fontSize(14)
                    .fontColor('#007AFF')
                    .margin({ right: 8 })
                  Text('è¯·ç¡®ä¿æ‚¨åœ¨æ´»åŠ¨ç°åœºé™„è¿‘')
                    .fontSize(13)
                    .fontColor('#666666')
                }
                .alignItems(VerticalAlign.Top)
                .margin({ bottom: 4 })

                Row() {
                  Text('â€¢')
                    .fontSize(14)
                    .fontColor('#007AFF')
                    .margin({ right: 8 })
                  Text('ç­¾åˆ°èŒƒå›´ï¼šæ´»åŠ¨åœ°ç‚¹å‘¨å›´100ç±³')
                    .fontSize(13)
                    .fontColor('#666666')
                }
                .alignItems(VerticalAlign.Top)
                .margin({ bottom: 4 })

                Row() {
                  Text('â€¢')
                    .fontSize(14)
                    .fontColor('#007AFF')
                    .margin({ right: 8 })
                  Text('æ¯ä¸ªæ´»åŠ¨åªèƒ½ç­¾åˆ°ä¸€æ¬¡')
                    .fontSize(13)
                    .fontColor('#666666')
                }
                .alignItems(VerticalAlign.Top)
              }
            }
            .width('100%')
            .margin({ bottom: 20 })

            // ç­¾åˆ°æŒ‰é’®
            Button('ç­¾åˆ°')
              .width('100%')
              .height(48)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
              .backgroundColor('#007AFF')
              .borderRadius(24)
              .onClick(() => {
                this.handleCheckIn()
              })
              .shadow({
                radius: 8,
                color: 'rgba(0, 122, 255, 0.3)',
                offsetX: 0,
                offsetY: 4
              })
          }
          .width('100%')
          .padding(20)
          .backgroundColor(Color.White)
          .borderRadius({ topLeft: 20, topRight: 20 })
          .position({ x: 0, y: '100%' })
          .translate({ y: -200 })
          .shadow({
            radius: 16,
            color: 'rgba(0,0,0,0.1)',
            offsetX: 0,
            offsetY: -4
          })
        }
        .width('100%')
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
} 