import { AppColors, AppSizes } from '../../common/constants/AppConstants'
import { StatusBar } from '../../common/components/StatusBar'
import geolocation from '@ohos.geolocation'
import router from '@ohos.router'
import prompt from '@ohos.prompt'

interface Activity {
  id: string
  title: string
  time: string
  location: string
  image: Resource
  status: string
}

interface TabItem {
  icon: string
  text: string
  isActive: boolean
}

@Entry
@Component
export struct HomePage {
  @State currentTime: string = '10:24'
  @State location: string = ''
  @State latitude: number = 0
  @State longitude: number = 0
  @State searchText: string = ''
  @State showSearchHistory: boolean = false
  @State searchHistory: string[] = []
  @State searchResults: Activity[] = []
  @State isSearching: boolean = false
  @State favoriteStates: Map<string, boolean> = new Map()
  @State favoriteActivities: Activity[] = []
  
  // æŒä¹…åŒ–æ”¶è—æ•°æ®
  private storageKey = 'favorite_activities'

  // æ¨¡æ‹Ÿæ´»åŠ¨æ•°æ®
  private activities: Activity[] = [
    {
      id: '1',
      title: 'HarmonyOS æŠ€æœ¯åˆ†äº«ä¼š',
      time: 'ä»Šå¤© 19:00 - 21:00',
      location: 'æ•™å­¦æ¥¼ B201',
      image: $r('app.media.start'),
      status: 'ç«çƒ­æŠ¥åä¸­'
    },
    {
      id: '2',
      title: 'æ ¡å›­æ‘„å½±å¤§èµ›ä½œå“å±•',
      time: 'å‘¨ä¸‰è‡³å‘¨äº” å…¨å¤©',
      location: 'å›¾ä¹¦é¦†ä¸€æ¥¼å¤§å…',
      image: $r('app.media.activity'),
      status: 'å·²ç»“æŸ'
    },
    {
      id: '3',
      title: 'ç‹è€…è£è€€æ¯”èµ›',
      time: 'å‘¨å…­è‡³å‘¨å¤© å…¨å¤©',
      location: 'ç”µç«ä¸€æ¥¼å¤§å…',
      image: $r('app.media.good'),
      status: 'ç«çƒ­æŠ¥åä¸­'
    },
    {
      id: '4',
      title: 'æ ¡å›­æ‘‡æ»šéŸ³ä¹èŠ‚',
      time: 'ä¸‹å‘¨äº” 19:30',
      location: 'å­¦æ ¡æ“åœº',
      image: $r('app.media.speaker'),
      status: 'ç«çƒ­æŠ¥åä¸­'
    }
  ]

  aboutToAppear() {
    this.getCurrentLocation()
    this.loadFavorites()
  }

  // åŠ è½½æ”¶è—æ•°æ®
  loadFavorites() {
    try {
      const storedFavorites = AppStorage.get<Activity[]>(this.storageKey)
      if (storedFavorites && Array.isArray(storedFavorites)) {
        this.favoriteActivities = storedFavorites
        // é‡å»ºæ”¶è—çŠ¶æ€Map
        this.favoriteStates.clear()
        this.favoriteActivities.forEach(activity => {
          this.favoriteStates.set(activity.id, true)
        })
      }
    } catch (error) {
      console.error('åŠ è½½æ”¶è—æ•°æ®å¤±è´¥:', JSON.stringify(error))
    }
  }

  // ä¿å­˜æ”¶è—æ•°æ®
  saveFavorites() {
    try {
      AppStorage.setOrCreate<Activity[]>(this.storageKey, this.favoriteActivities)
    } catch (error) {
      console.error('ä¿å­˜æ”¶è—æ•°æ®å¤±è´¥:', JSON.stringify(error))
    }
  }

  // åˆ‡æ¢æ”¶è—çŠ¶æ€
  toggleFavorite(activity: Activity) {
    const isCurrentlyFavorited = this.favoriteStates.get(activity.id) || false
    
    if (isCurrentlyFavorited) {
      // å–æ¶ˆæ”¶è—
      this.favoriteStates.set(activity.id, false)
      this.favoriteActivities = this.favoriteActivities.filter(item => item.id !== activity.id)
    } else {
      // æ·»åŠ æ”¶è—
      this.favoriteStates.set(activity.id, true)
      this.favoriteActivities.push(activity)
    }
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    this.saveFavorites()
  }

  async getCurrentLocation() {
    try {
      let requestInfo: geolocation.LocationRequest = {
        priority: geolocation.LocationRequestPriority.ACCURACY,
        scenario: geolocation.LocationRequestScenario.NAVIGATION,
        timeInterval: 0,
        distanceInterval: 0,
        maxAccuracy: 0
      }
      
      let locationRequest = await geolocation.on('locationChange', requestInfo, (location: geolocation.Location) => {
        this.location = `${location.latitude}, ${location.longitude}`
        this.latitude = location.latitude
        this.longitude = location.longitude
        geolocation.off('locationChange')
      })
    } catch (err) {
      console.error('è·å–ä½ç½®å¼‚å¸¸ï¼š' + JSON.stringify(err))
    }
  }

  handleCheckIn() {
    if (!this.location) {
      this.getCurrentLocation()
    }
    
    router.pushUrl({
      url: 'pages/HomePage_yanglinsen/MapPage',
      params: {
        latitude: this.latitude,
        longitude: this.longitude
      }
    })
  }

  handleSearch(text: string) {
    if (!text.trim()) {
      this.searchResults = []
      this.isSearching = false
      return
    }

    // æ‰§è¡Œæœç´¢
    this.isSearching = true
    this.searchResults = this.activities.filter(activity => 
      activity.title.toLowerCase().includes(text.toLowerCase()) ||
      activity.location.toLowerCase().includes(text.toLowerCase())
    )
  }

  // å¤„ç†æœç´¢æäº¤ï¼ˆæŒ‰å›è½¦ï¼‰
  handleSearchSubmit(text: string) {
    if (!text.trim()) {
      return
    }

    // æ·»åŠ åˆ°æœç´¢å†å²
    if (!this.searchHistory.includes(text)) {
      this.searchHistory.unshift(text)
      // åªä¿ç•™æœ€è¿‘10æ¡æœç´¢è®°å½•
      if (this.searchHistory.length > 10) {
        this.searchHistory.pop()
      }
    }

    this.showSearchHistory = false
    this.handleSearch(text)
  }

  // æ¸…é™¤æœç´¢å†å²
  clearSearchHistory() {
    this.searchHistory = []
  }

  deleteSearchHistoryItem(itemToDelete: string) {
    this.searchHistory = this.searchHistory.filter(item => item !== itemToDelete)
  }

  @Builder
  SearchHistoryBuilder() {
    Column() {
      Row() {
        Text('æœç´¢å†å²')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
        Blank()
        Text('æ¸…é™¤')
          .fontSize(14)
          .fontColor('#007AFF')
          .onClick(() => this.clearSearchHistory())
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 16, bottom: 8 })

      ForEach(this.searchHistory, (item: string) => {
        Row() {
          Row() {
            Text('\u{1F4C5}')  // ğŸ“…
              .fontSize(16)
              .fontColor('#8E8E93')
            Text(item)
              .fontSize(14)
              .fontColor('#333333')
              .margin({ left: 8 })
          }
          .layoutWeight(1)

          Blank()
          Text('\u{2716}') // âœ–
            .fontSize(18)
            .fontColor('#8E8E93')
            .onClick(() => this.deleteSearchHistoryItem(item))
        }
        .width('100%')
        .height(44)
        .padding({ left: 16, right: 16 })
        .backgroundColor(Color.White)
        .onClick(() => {
          this.searchText = item
          this.showSearchHistory = false
          this.handleSearch(item)
        })
      })
    }
    .width(330)
    .backgroundColor(Color.White)
    .borderRadius({ topLeft: 0, topRight: 0, bottomLeft: 12, bottomRight: 12 })
    .margin({ top: 4 })
    .shadow({
      radius: 10,
      color: 'rgba(0,0,0,0.1)',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  SearchResultsBuilder() {
    Column() {
      Text('æœç´¢ç»“æœ')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 8 })

      ForEach(this.searchResults, (item: Activity) => {
        Row() {
          Image(item.image)
            .width(100)
            .height(100)
            .borderRadius(8)
            .objectFit(ImageFit.Cover)

          Column() {
            Text(item.title)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 4 })

            Row() {
              Text('\u{1F550}')  // ğŸ•
                .fontSize(16)
                .fontColor('#8E8E93')
              Text(item.time)
                .fontSize(13)
                .fontColor('#8E8E93')
            }
            .margin({ bottom: 4 })

            Row() {
              Text('\u{1F4CD}')  // ğŸ“
                .fontSize(16)
                .fontColor('#8E8E93')
              Text(item.location)
                .fontSize(13)
                .fontColor('#8E8E93')
            }

            Row() {
              Text(item.status)
                .fontSize(12)
                .fontWeight(FontWeight.Medium)
                .fontColor(item.status === 'ç«çƒ­æŠ¥åä¸­' ? '#34C759' : '#8E8E93')
                .backgroundColor(item.status === 'ç«çƒ­æŠ¥åä¸­' ? '#EAF7ED' : '#F2F2F7')
                .borderRadius(16)
                .padding({ left: 10, right: 10, top: 4, bottom: 4 })
                .margin({ top: 8 })

              Image(this.favoriteStates.get(item.id) ? $r('app.media.souc') : $r('app.media.sous'))
                .width(24)
                .height(24)
                .margin({ left: 96, top: 8 })
                .position({ x: 96 })
                .onClick(() => {
                  this.toggleFavorite(item)
                })
            }
          }
          .alignItems(HorizontalAlign.Start)
          .margin({ left: 16 })
          .layoutWeight(1)
        }
        .width('100%')
        .padding(16)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .margin({ left: 16, right: 16, top: 8 })
        .onClick(() => {
          router.pushUrl({
            url: 'pages/ActivityPage_wuguixing/ActivityPage',
            params: {
              activity: item
            }
          })
        })
      })
    }
    .width('100%')
  }

  @Builder
  NormalContentBuilder() {
    Column() {
      // Quick Entry Grid
      Grid() {
        GridItem() {
          Column() {
            Column() {
              Text('ğŸ“')
                .fontSize(AppSizes.ICON_BASE)
                .fontColor(AppColors.TEXT_WHITE)
            }
            .width(50)
            .height(50)
            .borderRadius(AppSizes.RADIUS_LG)
            .backgroundColor(AppColors.ENTRY_ORANGE)
            .justifyContent(FlexAlign.Center)

            Text('å¿«æ·é¢„çº¦')
              .fontSize(AppSizes.FONT_SM + 1)
              .fontWeight(FontWeight.Medium)
              .margin({ top: AppSizes.SPACING_SM })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/HomePage_yanglinsen/QuickBookingPageEntry'
            }).catch((error: Error) => {
              console.error('è·¯ç”±è·³è½¬å¤±è´¥:', error.message)
            })
          })
        }

        GridItem() {
          Column() {
            Column() {
              Text('\u{1F4CD}') // ğŸ“
                .fontSize(AppSizes.ICON_BASE)
                .fontColor(AppColors.TEXT_WHITE)
            }
            .width(50)
            .height(50)
            .borderRadius(AppSizes.RADIUS_LG)
            .backgroundColor(AppColors.ENTRY_GREEN)
            .justifyContent(FlexAlign.Center)
            Text('å®šä½ç­¾åˆ°')
              .fontSize(AppSizes.FONT_SM + 1)
              .fontWeight(FontWeight.Medium)
              .margin({ top: AppSizes.SPACING_SM })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .onClick(() => {
            this.handleCheckIn()
          })
        }

        GridItem() {
          Column() {
            Column() {
              Text('â­')
                .fontSize(AppSizes.ICON_BASE)
                .fontColor(AppColors.TEXT_WHITE)
            }
            .width(50)
            .height(50)
            .borderRadius(AppSizes.RADIUS_LG)
            .backgroundColor(AppColors.ENTRY_BLUE)
            .justifyContent(FlexAlign.Center)

            Text('æˆ‘çš„æ”¶è—')
              .fontSize(AppSizes.FONT_SM + 1)
              .fontWeight(FontWeight.Medium)
              .margin({ top: AppSizes.SPACING_SM })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/HomePage_yanglinsen/FavoritesPage'
            })
          })
        }

        GridItem() {
          Column() {
            Column() {
              Text('â“')
                .fontSize(AppSizes.ICON_BASE)
                .fontColor(AppColors.TEXT_WHITE)
            }
            .width(50)
            .height(50)
            .borderRadius(AppSizes.RADIUS_LG)
            .backgroundColor(AppColors.ENTRY_TEAL)
            .justifyContent(FlexAlign.Center)

            Text('å¸®åŠ©ä¸­å¿ƒ')
              .fontSize(AppSizes.FONT_SM + 1)
              .fontWeight(FontWeight.Medium)
              .margin({ top: AppSizes.SPACING_SM })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/HomePage_yanglinsen/HelpCenterPageEntry'
            }).catch((error: Error) => {
              console.error('è·¯ç”±è·³è½¬å¤±è´¥:', error.message)
            })
          })
        }
      }
      .columnsTemplate('1fr 1fr 1fr 1fr')
      .rowsTemplate('1fr')
      .columnsGap(AppSizes.SPACING_LG)
      .rowsGap(AppSizes.SPACING_LG)
      .height(120)
      .padding({
        left: 10,
        right: 10,
        top: AppSizes.SPACING_LG,
        bottom: AppSizes.SPACING_LG
      })
      .backgroundColor(AppColors.BG_CARD)
      .borderRadius({ topLeft: AppSizes.RADIUS_LG, topRight: AppSizes.RADIUS_LG, bottomLeft: 0, bottomRight: 0 })
      .margin({ left: 10, right: 10, top: 0 })
      .shadow({
        radius: 10,
        color: 'rgba(0,0,0,0.05)',
        offsetX: 0,
        offsetY: 4
      })

      // Hot Activities Section
      Row() {
        Text('çƒ­é—¨æ´»åŠ¨')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        Text('æŸ¥çœ‹å…¨éƒ¨ >')
          .fontSize(14)
          .fontColor('#8E8E93')
          .onClick(() => {
            router.pushUrl({
              url: 'pages/ActivityPage_wuguixing/ActivityPage'
            })
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding({ left: 10, right: 10, top: 16 })
      .backgroundColor(AppColors.BG_CARD)
      .margin({ left: 10, right: 10 })
      .borderRadius({ bottomLeft: AppSizes.RADIUS_LG, bottomRight: AppSizes.RADIUS_LG })
    }
  }

  build() {
    Stack() {
      // Header Section with gradient background
      Column() {
        // User Info
        Row() {
          Image($r('app.media.img'))
            .width(48)
            .height(48)
            .borderRadius(24)
            .border({ width: 2, color: Color.White })

          Column() {
            Text('ä¸‹åˆå¥½, åŒå­¦')
              .fontSize(20)
              .fontWeight(FontWeight.Medium)
              .fontColor(Color.White)
            Text('ä»Šå¤©ä¹Ÿæ˜¯å……æ»¡æ´»åŠ›çš„ä¸€å¤©')
              .fontSize(14)
              .fontColor(Color.White)
              .opacity(0.8)
          }
          .alignItems(HorizontalAlign.Start)
          .margin({ left: 12 })
          .layoutWeight(1)
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)

        // Search Bar
        Row() {
          Text('\u{1F50D}')  // ğŸ”
            .fontSize(20)
            .fontColor(Color.White)
            .opacity(0.8)
          TextInput({ placeholder: 'æœç´¢ä½ æ„Ÿå…´è¶£çš„æ´»åŠ¨', text: this.searchText })
            .fontSize(14)
            .fontColor(Color.White)
            .backgroundColor('transparent')
            .placeholderColor('rgba(255,255,255,0.8)')
            .placeholderFont({ size: 14 })
            .layoutWeight(1)
            .onChange((value: string) => {
              this.searchText = value
              this.showSearchHistory = true
              if (!value.trim()) {
                this.isSearching = false
                this.searchResults = []
              }
            })
            .onSubmit((enterKey: EnterKeyType, event: SubmitEvent) => {
              this.handleSearchSubmit(this.searchText)
            })
            .onFocus(() => {
              this.showSearchHistory = true
            })
            .onBlur(() => {
              // å»¶è¿Ÿå…³é—­æœç´¢å†å²ï¼Œä»¥ä¾¿ç”¨æˆ·èƒ½ç‚¹å‡»å†å²è®°å½•
              setTimeout(() => {
                this.showSearchHistory = false
              }, 200)
            })
        }
        .width('100%')
        .height(40)
        .backgroundColor('rgba(255,255,255,0.2)')
        .borderRadius(8)
        .padding({ left: 16, right: 16 })
        .margin({ top: 16 })
        .justifyContent(FlexAlign.Start)
      }
      .width('100%')
      .padding({ top: 16, left: 16, right: 16, bottom: 70 })
      .linearGradient({
        angle: 135,
        colors: [['#007AFF', 0.0], ['#00C6FF', 1.0]]
      })
      .borderRadius({ bottomLeft: 24, bottomRight: 24 })
      .position({ x: 0, y: 0 })
      .zIndex(3)
      .onClick(() => {
        // ç‚¹å‡»HeaderåŒºåŸŸæ—¶ï¼Œè®©æœç´¢æ¡†å¤±å»ç„¦ç‚¹
        this.showSearchHistory = false
      })

      // Search History
      if (this.showSearchHistory && this.searchHistory.length > 0) {
        Column() {
          this.SearchHistoryBuilder()
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
        .position({ x: 0, y: 124 }) // Position absolutely within Stack
        .zIndex(7) // Ensure it's above other content
      }

      // Fixed Content Section (Quick Entry Grid + Hot Activities Section)
      Column() {
        this.NormalContentBuilder()
      }
      .width('100%')
      .position({ x: 0, y: 150 })
      .zIndex(5)
      .onClick(() => {
        // ç‚¹å‡»Fixed ContentåŒºåŸŸæ—¶ï¼Œè®©æœç´¢æ¡†å¤±å»ç„¦ç‚¹
        this.showSearchHistory = false
      })

      // Scrollable Activity Cards
      Scroll() {
        Column() {
          if (this.isSearching) {
            this.SearchResultsBuilder()
          } else {
            Column() {
              ForEach(this.activities, (item: Activity) => {
                Row() {
                  Image(item.image)
                    .width(100)
                    .height(100)
                    .borderRadius(8)
                    .objectFit(ImageFit.Cover)

                  Column() {
                    Text(item.title)
                      .fontSize(16)
                      .fontWeight(FontWeight.Medium)
                      .margin({ bottom: 4 })

                    Row() {
                      Text('\u{1F550}')  // ğŸ•
                        .fontSize(16)
                        .fontColor('#8E8E93')
                      Text(item.time)
                        .fontSize(13)
                        .fontColor('#8E8E93')
                    }
                    .margin({ bottom: 4 })

                    Row() {
                      Text('\u{1F4CD}')  // ğŸ“
                        .fontSize(16)
                        .fontColor('#8E8E93')
                      Text(item.location)
                        .fontSize(13)
                        .fontColor('#8E8E93')
                    }

                    Row() {
                      Text(item.status)
                        .fontSize(12)
                        .fontWeight(FontWeight.Medium)
                        .fontColor(item.status === 'ç«çƒ­æŠ¥åä¸­' ? '#34C759' : '#8E8E93')
                        .backgroundColor(item.status === 'ç«çƒ­æŠ¥åä¸­' ? '#EAF7ED' : '#F2F2F7')
                        .borderRadius(16)
                        .padding({ left: 10, right: 10, top: 4, bottom: 4 })
                        .margin({ top: 8 })

                      Image(this.favoriteStates.get(item.id) ? $r('app.media.souc') : $r('app.media.sous'))
                        .width(24)
                        .height(24)
                        .margin({ left: 96, top: 8 })
                        .position({ x: 96 })
                        .onClick(() => {
                          this.toggleFavorite(item)
                        })
                    }
                  }
                  .alignItems(HorizontalAlign.Start)
                  .margin({ left: 16 })
                  .layoutWeight(1)
                }
                .width('100%')
                .padding(16)
                .backgroundColor(Color.White)
                .borderRadius(12)
                .margin({ left: 16, right: 16, top: 8 })
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/ActivityPage_wuguixing/ActivityPage',
                    params: {
                      activity: item
                    }
                  })
                })
              })
            }
            .padding({ top: 290, bottom: 80 }) // å‡å°‘é¡¶éƒ¨paddingï¼Œä¸ºçƒ­é—¨æ´»åŠ¨æ ‡é¢˜ç•™å‡ºç©ºé—´
          }
        }
      }
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
      .width('100%')
      .height('100%')
      .zIndex(2)
      .onClick(() => {
        // ç‚¹å‡»ScrollåŒºåŸŸæ—¶ï¼Œè®©æœç´¢æ¡†å¤±å»ç„¦ç‚¹
        this.showSearchHistory = false
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F2F2F7')
    .onClick(() => {
      // ç‚¹å‡»StackåŒºåŸŸæ—¶ï¼Œè®©æœç´¢æ¡†å¤±å»ç„¦ç‚¹
      this.showSearchHistory = false
    })
  }
} 