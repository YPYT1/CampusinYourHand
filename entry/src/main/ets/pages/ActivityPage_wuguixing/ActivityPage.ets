import router from '@ohos.router'
import { CommonCard } from '../../common/components/CommonCard'
import dataPreferences from '@ohos.data.preferences'
import prompt from '@ohos.prompt'

interface Activity {
  id: string
  title: string
  time: string
  location: string
  image: Resource
  status: string
  type: string
  participants: number
  maxParticipants: number
  description: string
  isRegistered?: boolean  // æ·»åŠ æŠ¥åçŠ¶æ€
}

interface Record {
  title: string
  time: string
  location: string
  status: 'å·²é¢„çº¦' | 'å·²å‚åŠ ' | 'å·²å–æ¶ˆ' | 'å·²è¿‡æœŸ'
  showQRCode?: boolean
  canRate?: boolean
  canCancel?: boolean
}

@Entry
@Component
export struct ActivityPage {
  @State activities: Activity[] = [
    {
      id: '1',
      title: 'HarmonyOS æŠ€æœ¯åˆ†äº«ä¼š',
      time: 'ä»Šå¤© 19:00 - 21:00',
      location: 'æ•™å­¦æ¥¼ B201',
      image: $r('app.media.img'),
      status: 'ç«çƒ­æŠ¥åä¸­',
      type: 'æŠ€æœ¯è®²åº§',
      participants: 23,
      maxParticipants: 100,
      description: 'æ·±å…¥äº†è§£HarmonyOSå¼€å‘æŠ€æœ¯ï¼Œåˆ†äº«å®žé™…é¡¹ç›®ç»éªŒ',
      isRegistered: false
    },
    {
      id: '2',
      title: 'æ ¡å›­æ‘„å½±å¤§èµ›ä½œå“å±•',
      time: 'å‘¨ä¸‰è‡³å‘¨äº” å…¨å¤©',
      location: 'å›¾ä¹¦é¦†ä¸€æ¥¼å¤§åŽ…',
      image: $r('app.media.img'),
      status: 'è¿›è¡Œä¸­',
      type: 'è‰ºæœ¯å±•è§ˆ',
      participants: 156,
      maxParticipants: 200,
      description: 'å±•ç¤ºå­¦ç”Ÿä¼˜ç§€æ‘„å½±ä½œå“ï¼Œæ„Ÿå—è‰ºæœ¯ä¹‹ç¾Ž',
      isRegistered: false
    },
    {
      id: '3',
      title: 'çŽ‹è€…è£è€€æ ¡å›­è”èµ›',
      time: 'å‘¨å…­è‡³å‘¨å¤© å…¨å¤©',
      location: 'ç”µç«žé¦†ä¸€æ¥¼',
      image: $r('app.media.img'),
      status: 'ç«çƒ­æŠ¥åä¸­',
      type: 'ç”µç«žæ¯”èµ›',
      participants: 89,
      maxParticipants: 128,
      description: 'æ ¡å›­ç”µç«žç››äº‹ï¼Œå±•çŽ°ä½ çš„æ¸¸æˆæŠ€å·§',
      isRegistered: false
    },
    {
      id: '4',
      title: 'åˆ›ä¸šåˆ†äº«äº¤æµä¼š',
      time: 'ä¸‹å‘¨äºŒ 14:00 - 16:00',
      location: 'åˆ›æ–°åˆ›ä¸šä¸­å¿ƒ',
      image: $r('app.media.img'),
      status: 'å³å°†å¼€å§‹',
      type: 'åˆ›ä¸šè®²åº§',
      participants: 45,
      maxParticipants: 80,
      description: 'ä¼˜ç§€æ ¡å‹åˆ†äº«åˆ›ä¸šç»éªŒå’Œå¿ƒå¾—',
      isRegistered: false
    },
    {
      id: '5',
      title: 'æ˜¥å­£è¿åŠ¨ä¼š',
      time: 'ä¸‹å‘¨äº”-å…­ 08:00 - 18:00',
      location: 'å­¦æ ¡ç”°å¾„åœº',
      image: $r('app.media.img'),
      status: 'ç«çƒ­æŠ¥åä¸­',
      type: 'ä½“è‚²èµ›äº‹',
      participants: 234,
      maxParticipants: 500,
      description: 'å±•çŽ°é’æ˜¥æ´»åŠ›ï¼ŒæŒ‘æˆ˜è¿åŠ¨æžé™',
      isRegistered: false
    },
    {
      id: '6',
      title: 'éŸ³ä¹èŠ‚æ¼”å‡º',
      time: 'ä¸‹å‘¨æ—¥ 19:00 - 22:00',
      location: 'å­¦æ ¡å¤§ç¤¼å ‚',
      image: $r('app.media.img'),
      status: 'ç«çƒ­æŠ¥åä¸­',
      type: 'æ–‡è‰ºæ¼”å‡º',
      participants: 167,
      maxParticipants: 300,
      description: 'ç²¾å½©çš„éŸ³ä¹æ¼”å‡ºï¼Œæ„Ÿå—è‰ºæœ¯é­…åŠ›',
      isRegistered: false
    }
  ]
  
  @State selectedCategory: string = 'å…¨éƒ¨'
  @State filteredActivities: Activity[] = this.activities.slice()
  
  private categories: string[] = ['å…¨éƒ¨', 'æŠ€æœ¯è®²åº§', 'è‰ºæœ¯å±•è§ˆ', 'ç”µç«žæ¯”èµ›', 'åˆ›ä¸šè®²åº§', 'ä½“è‚²èµ›äº‹', 'æ–‡è‰ºæ¼”å‡º']
  private preferences: dataPreferences.Preferences | null = null

  async aboutToAppear() {
    try {
      this.preferences = await dataPreferences.getPreferences(getContext(), 'activity_preferences')
      this.filterActivities()
    } catch (err) {
      console.error('Failed to get preferences:', err)
    }
  }

  filterActivities() {
    if (this.selectedCategory === 'å…¨éƒ¨') {
      this.filteredActivities = this.activities.slice()
    } else {
      this.filteredActivities = this.activities.filter(activity => activity.type === this.selectedCategory)
    }
  }

  getStatusColor(status: string): string {
    switch (status) {
      case 'ç«çƒ­æŠ¥åä¸­':
        return '#FF6B6B'
      case 'è¿›è¡Œä¸­':
        return '#4ECDC4'
      case 'å³å°†å¼€å§‹':
        return '#45B7D1'
      case 'å·²ç»“æŸ':
        return '#96CEB4'
      default:
        return '#DEDEDE'
    }
  }

  getStatusBgColor(status: string): string {
    switch (status) {
      case 'ç«çƒ­æŠ¥åä¸­':
        return '#FFE8E8'
      case 'è¿›è¡Œä¸­':
        return '#E8F8F7'
      case 'å³å°†å¼€å§‹':
        return '#E8F4FD'
      case 'å·²ç»“æŸ':
        return '#F0F8F4'
      default:
        return '#F5F5F5'
    }
  }

  // ä¿®æ”¹æŠ¥åå¤„ç†å‡½æ•°
  async handleRegistration(activity: Activity) {
    if (activity.status === 'ç«çƒ­æŠ¥åä¸­' && !activity.isRegistered) {
      // åˆ›å»ºæ–°çš„æ´»åŠ¨æ•°ç»„ä»¥è§¦å‘çŠ¶æ€æ›´æ–°
      const updatedActivities = this.activities.map(a => {
        if (a.id === activity.id) {
          const updatedActivity: Activity = {
            id: a.id,
            title: a.title,
            time: a.time,
            location: a.location,
            image: a.image,
            status: a.status,
            type: a.type,
            participants: a.participants + 1,
            maxParticipants: a.maxParticipants,
            description: a.description,
            isRegistered: true
          }
          return updatedActivity
        }
        return a
      })
      
      // æ›´æ–°æ´»åŠ¨åˆ—è¡¨
      this.activities = updatedActivities.slice()
      
      // æ›´æ–°è¿‡æ»¤åŽçš„æ´»åŠ¨åˆ—è¡¨
      this.filterActivities()

      // æ·»åŠ åˆ°é¢„çº¦è®°å½•
      const newRecord: Record = {
        title: activity.title,
        time: activity.time,
        location: activity.location,
        status: 'å·²é¢„çº¦',
        canCancel: true,
        showQRCode: true
      }

      try {
        if (this.preferences) {
          // èŽ·å–çŽ°æœ‰è®°å½•
          let records: Record[] = []
          const storedRecords = await this.preferences.get('user_records', '[]')
          if (storedRecords && storedRecords !== '[]') {
            try {
              records = JSON.parse(storedRecords as string)
            } catch (e) {
              console.error('Failed to parse stored records:', e)
              records = []
            }
          }

          // æ·»åŠ æ–°è®°å½•
          records.unshift(newRecord)

          // ä¿å­˜è®°å½•
          await this.preferences.put('user_records', JSON.stringify(records))
          await this.preferences.flush()

          // æ˜¾ç¤ºæˆåŠŸæç¤º
          prompt.showToast({
            message: 'æŠ¥åæˆåŠŸï¼',
            duration: 2000
          })
        }
      } catch (err) {
        console.error('Failed to save record:', err)
        prompt.showToast({
          message: 'ä¿å­˜è®°å½•å¤±è´¥',
          duration: 2000
        })
      }
    }
  }

  build() {
    Column() {
      // å¤´éƒ¨æ¸å˜èƒŒæ™¯
      Column() {
        Row() {
          Image($r('app.media.back'))
            .width(24)
            .height(24)
            .fillColor(Color.White)
            .onClick(() => {
              router.back()
            })
          
          Text('æ ¡å›­æ´»åŠ¨')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
            
          Text('')
            .width(24)
        }
        .width('100%')
        .height(56)
        .padding({ left: 16, right: 16 })
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)
      }
      .width('100%')
      .padding({ top: 44, bottom: 16 })
      .linearGradient({
        angle: 135,
        colors: [['#667eea', 0.0], ['#764ba2', 1.0]]
      })

      Scroll() {
        Column() {
          // åˆ†ç±»é€‰æ‹©å™¨
          Column() {
            Text('æ´»åŠ¨åˆ†ç±»')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .alignSelf(ItemAlign.Start)
              .margin({ bottom: 12 })

            List() {
              ForEach(this.categories, (category: string) => {
                ListItem() {
                  Text(category)
                    .fontSize(14)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(this.selectedCategory === category ? Color.White : '#667eea')
                    .backgroundColor(this.selectedCategory === category ? '#667eea' : '#F0F2FF')
                    .borderRadius(20)
                    .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                    .margin({ right: 12 })
                    .onClick(() => {
                      this.selectedCategory = category
                      this.filterActivities()
                    })
                }
              })
            }
            .listDirection(Axis.Horizontal)
            .width('100%')
            .height(40)
            .padding({ right: 16 })
          }
          .width('100%')
          .padding(16)
          .backgroundColor(Color.White)
          .borderRadius(16)
          .margin({ top: 16, bottom: 16 })
          .shadow({
            radius: 8,
            color: 'rgba(0,0,0,0.1)',
            offsetX: 0,
            offsetY: 4
          })

          // æ´»åŠ¨ç»Ÿè®¡
          Row() {
            Column() {
              Text(`${this.filteredActivities.length}`)
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#667eea')
              Text('æ´»åŠ¨æ€»æ•°')
                .fontSize(12)
                .fontColor('#999999')
            }
            .layoutWeight(1)

            Column() {
              Text(`${this.filteredActivities.filter(a => a.status === 'ç«çƒ­æŠ¥åä¸­').length}`)
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FF6B6B')
              Text('æŠ¥åä¸­')
                .fontSize(12)
                .fontColor('#999999')
            }
            .layoutWeight(1)

            Column() {
              Text(`${this.filteredActivities.filter(a => a.status === 'è¿›è¡Œä¸­').length}`)
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#4ECDC4')
              Text('è¿›è¡Œä¸­')
                .fontSize(12)
                .fontColor('#999999')
            }
            .layoutWeight(1)
          }
          .width('100%')
          .padding(16)
          .backgroundColor(Color.White)
          .borderRadius(16)
          .margin({ bottom: 16 })
          .shadow({
            radius: 8,
            color: 'rgba(0,0,0,0.1)',
            offsetX: 0,
            offsetY: 4
          })

          // æ´»åŠ¨åˆ—è¡¨
          ForEach(this.filteredActivities, (activity: Activity) => {
            Column() {
              // æ´»åŠ¨å›¾ç‰‡
              Image(activity.image)
                .width('100%')
                .height(180)
                .borderRadius({ topLeft: 16, topRight: 16 })
                .objectFit(ImageFit.Cover)

              // æ´»åŠ¨ä¿¡æ¯
              Column() {
                // æ ‡é¢˜å’ŒçŠ¶æ€
                Row() {
                  Text(activity.title)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#333333')
                    .layoutWeight(1)
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })

                  Text(activity.status)
                    .fontSize(11)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(this.getStatusColor(activity.status))
                    .backgroundColor(this.getStatusBgColor(activity.status))
                    .borderRadius(12)
                    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                }
                .width('100%')
                .margin({ bottom: 8 })
                .alignItems(VerticalAlign.Top)

                // ç±»åž‹æ ‡ç­¾
                Text(activity.type)
                  .fontSize(12)
                  .fontColor('#667eea')
                  .backgroundColor('#F0F2FF')
                  .borderRadius(8)
                  .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                  .alignSelf(ItemAlign.Start)
                  .margin({ bottom: 8 })

                // æ—¶é—´å’Œåœ°ç‚¹
                Row() {
                  Text('ðŸ•')
                    .fontSize(14)
                  Text(activity.time)
                    .fontSize(13)
                    .fontColor('#666666')
                    .margin({ left: 4 })
                }
                .margin({ bottom: 4 })

                Row() {
                  Text('ðŸ“')
                    .fontSize(14)
                  Text(activity.location)
                    .fontSize(13)
                    .fontColor('#666666')
                    .margin({ left: 4 })
                }
                .margin({ bottom: 8 })

                // å‚ä¸Žäººæ•°è¿›åº¦æ¡
                Column() {
                  Row() {
                    Text('æŠ¥åè¿›åº¦')
                      .fontSize(12)
                      .fontColor('#666666')
                    Blank()
                    Text(`${activity.participants}/${activity.maxParticipants}`)
                      .fontSize(12)
                      .fontColor('#667eea')
                      .fontWeight(FontWeight.Medium)
                  }
                  .width('100%')
                  .margin({ bottom: 4 })

                  Progress({
                    value: activity.participants,
                    total: activity.maxParticipants,
                    type: ProgressType.Linear
                  })
                    .width('100%')
                    .height(4)
                    .backgroundColor('#F0F0F0')
                    .color('#667eea')
                    .borderRadius(2)
                }
                .width('100%')
                .margin({ bottom: 8 })

                // æè¿°
                Text(activity.description)
                  .fontSize(13)
                  .fontColor('#888888')
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .margin({ bottom: 12 })

                // æ“ä½œæŒ‰é’®
                Row() {
                  Button('æŸ¥çœ‹è¯¦æƒ…')
                    .fontSize(14)
                    .fontColor('#667eea')
                    .backgroundColor('#F0F2FF')
                    .borderRadius(20)
                    .height(36)
                    .layoutWeight(1)
                    .margin({ right: 8 })
                    .onClick(() => {
                      router.pushUrl({
                        url: 'pages/ActivityDetailPage',
                        params: { activity: activity }
                      })
                    })

                  Button(activity.isRegistered ? 'å·²æŠ¥å' : 
                    (activity.status === 'ç«çƒ­æŠ¥åä¸­' ? 'ç«‹å³æŠ¥å' : 
                    (activity.status === 'è¿›è¡Œä¸­' ? 'è¿›è¡Œä¸­' : 
                    (activity.status === 'å³å°†å¼€å§‹' ? 'å³å°†å¼€å§‹' : 'å·²ç»“æŸ'))))
                    .fontSize(14)
                    .fontColor(Color.White)
                    .backgroundColor(activity.isRegistered ? '#4ECDC4' : 
                      (activity.status === 'ç«çƒ­æŠ¥åä¸­' ? '#FF6B6B' : 
                      (activity.status === 'è¿›è¡Œä¸­' ? '#4ECDC4' : 
                      (activity.status === 'å³å°†å¼€å§‹' ? '#45B7D1' : '#96CEB4'))))
                    .borderRadius(20)
                    .height(36)
                    .layoutWeight(1)
                    .onClick(() => {
                      if (activity.status === 'ç«çƒ­æŠ¥åä¸­' && !activity.isRegistered) {
                        this.handleRegistration(activity)
                      }
                    })
                }
                .width('100%')
              }
              .width('100%')
              .padding(16)
            }
            .width('100%')
            .backgroundColor(Color.White)
            .borderRadius(16)
            .margin({ bottom: 16 })
            .shadow({
              radius: 8,
              color: 'rgba(0,0,0,0.1)',
              offsetX: 0,
              offsetY: 4
            })
            .onClick(() => {
              router.pushUrl({
                url: 'pages/ActivityDetailPage',
                params: { activity: activity }
              })
            })
          })
        }
        .padding(16)
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FF')
  }
}
